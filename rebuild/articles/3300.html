<blockquote>
  <p>本站访问有些慢，应该是国内的网络对 vercel 不友好。但是我有一台几乎闲置的华为云 vps，于是尝试了一下配置本站的 CI/CD。记录过程。</p>
</blockquote>
<h3><sup class="fake-head" id="id-%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6"></sup><a class="header-link" href="#id-%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6"><p>前置条件</p></a></h3>
<ul>
<li><span style="color: #0083ab">服务器</span>：centos8</li>
<li><span style="color: #0083ab">项目</span>：需要 nodejs 编译的前端项目</li>
<li><span style="color: #0083ab">部署目标</span>：nginx</li>
</ul>
<h3><sup class="fake-head" id="id-%E8%BF%87%E7%A8%8B"></sup><a class="header-link" href="#id-%E8%BF%87%E7%A8%8B"><p>过程</p></a></h3>
<ol>
<li><p>安装 jenkins。参照<a target="_blank" href="https://www.jenkins.io/doc/book/installing/linux/#red-hat-centos">官网介绍</a>，安装完成后，可以在 <code>http://yourip:8080</code> 登入 jenkins 控制台，然后创建用户，安装推荐插件，等等。</p></li>
<li><p>配置凭据。进入 <em>Manage Credentials</em> 界面，Url 一般是 <code>http://yourip:8080/credentials</code>，创建一个 ssh 凭据，Private Key 字段需填写已经在 <a target="_blank" href="https://github.com/settings/keys">github 配置</a>过的 ssh <strong>密钥</strong>，密钥位置一般在 <code>~/.ssh/id_rsa</code>。<span class="image-container"><img data-viewer="" alt="ssh凭据" title="ssh凭据" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOdNj0.png"><small class="desc">ssh 凭据</small></span>
接着新建一个 secret text 凭据，输入密码，用于等会配置 webhook：<span class="image-container"><img data-viewer="" alt="secret text凭据" title="secret text凭据" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qO4XSx.png"><small class="desc">secret text 凭据</small></span></p></li>
<li><p>配置 NodeJS 插件。进入 <em>Plugin Manager</em> 界面，Url 一般是 <code>http://yourip:8080/pluginManager/available</code>，搜索并安装 <code>NodeJS Plugin</code>，这是安装后的效果：<span class="image-container"><img data-viewer="" alt="安装NodeJS插件" title="安装NodeJS插件" src="https://s1.ax1x.com/2022/04/05/qOdyC9.png"><small class="desc">安装 NodeJS 插件</small></span>
之后进入全局配置，Url 一般是 <code>http://yourip:8080/configureTools</code>，找到 <strong>NodeJS</strong> 字段，点击新增 NodeJS 按钮，输入别名、国内镜像、版本号、预装 yarn，然后保存：<span class="image-container"><img data-viewer="" alt="配置NodeJS插件" title="配置NodeJS插件" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOdDN4.png"><small class="desc">配置 NodeJS 插件</small></span></p></li>
<li><p>现在正式开始配置项目。先创建一个 freestyle 项目，Url 一般是 <code>http://yourip:8080/view/all/newJob</code>。进入配置界面，在<strong>源码管理</strong>栏，输入源码信息，选择刚刚创建的 ssh 凭据：<span class="image-container"><img data-viewer="" alt="源码信息" title="源码信息" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOdnjP.png"><small class="desc">源码信息</small></span>
在<strong>构建环境</strong>栏，勾上<span style="color: #0083ab"> GitHub hook trigger for GITScm polling</span>，并输入刚刚配置好的 NodeJS 环境：<span class="image-container"><img data-viewer="" alt="NodeJS信息" title="NodeJS信息" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOBfbV.png"><small class="desc">NodeJS 信息</small></span>
在<strong>构建</strong>栏，选择<code>执行shell</code>，输入 shell 信息：</p>
<pre><small>Bash</small><div></div><code class="bash language-bash hljs">node -v    <span class="hljs-comment"># 输出node版本</span>
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$WORKSPACE</span>    <span class="hljs-comment"># 确保进入工作目录</span>
yarn install --registry=https://registry.npm.taobao.org    <span class="hljs-comment"># 执行yarn install</span>
npm run generate    <span class="hljs-comment"># 执行generate</span>
<span class="hljs-built_in">rm</span> -rf /data/www/blog    <span class="hljs-comment"># 清空之前的数据</span>
<span class="hljs-built_in">cp</span> -r dist/ /data/www/blog    <span class="hljs-comment"># 拷贝dist</span>
</code></pre>
<p>到此已经配置完成，点击保存。可以在项目界面点击<strong>立即构建</strong>按钮，测试效果。</p></li>
<li><p>配置 nginx 和 DNS。关于 nginx 基本配置和 https 证书，这里不细讲。如果已有 nginx 服务，只需加一项 server 字段：<span class="image-container"><img data-viewer="" alt="增加一项**server**字段" title="增加一项**server**字段" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOdauV.png"><small class="desc">增加一项 <strong>server</strong> 字段</small></span>
配置 DNS，我用的是 dnspod 免费套餐，可以让境外访问解析到 vercel，默认解析到我们的服务器：<span class="image-container"><img data-viewer="" alt="境内境外分流" title="境内境外分流" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOdBEF.png"><small class="desc">境内境外分流</small></span></p></li>
<li><p>配置 webhook。进入 jenkins 配置界面，Url 一般是 <code>http://yourip:8080/configure</code>，找到 <strong>GitHub</strong>-&gt;<strong>Shared secrets</strong>，选择第 2 步创建的 secret text 凭据，然后保存：<span class="image-container"><img data-viewer="" alt="用于识别github的webhook" title="用于识别github的webhook" src="https://s1.ax1x.com/2022/04/05/qO4jl6.png"><small class="desc">用于识别 github 的 webhook</small></span>
打开项目 github 的配置界面，新建一个 Webhook，Payload URL 输入 <code>http://yourip:8080/github-webhook/</code>，secret 字段输入 secret text 凭据的密码，保存：<span class="image-container"><img data-viewer="" alt="github webhook" title="github webhook" style="width: 80% !important;" src="https://s1.ax1x.com/2022/04/05/qOWMz8.png"><small class="desc">github webhook</small></span></p></li>
</ol>
<h3><sup class="fake-head" id="id-%E5%AE%8C%E5%B7%A5"></sup><a class="header-link" href="#id-%E5%AE%8C%E5%B7%A5"><p>完工</p></a></h3>
<p>  以上步骤基本配置好了 CI/CD，实际的工作流程如下：</p>
<ol>
<li>用户推送代码到 github。</li>
<li>github 携带 secret，访问 <code>http://yourip:8080/github-webhook/</code>。</li>
<li>jenkins 收到请求，开始执行构建命令，构建完成后，<code>dist/</code> 文件夹被复制到 <code>/data/www/blog/</code>。</li>
<li>此时 <code>index.html</code> 等文件已经改变，网站已更新，用户访问网址可看到最新的构建。</li>
</ol>